<% @company ||= @invoice.company || current_user.company %>
<% @client  ||= @invoice.client %>

<% total_eur    = @invoice.total_cents.to_i / 100.0 %>
<% subtotal_eur = @invoice.subtotal_cents.to_i / 100.0 %>
<% vat_eur      = @invoice.vat_amount_cents.to_i / 100.0 %>

<% status_label, status_bg, status_text, status_dot =
  case @invoice.status
  when "paid"
    ["Pay√©e", "bg-emerald-50", "text-emerald-700", "bg-emerald-500"]
  when "pending"
    ["En attente", "bg-amber-50", "text-amber-700", "bg-amber-500"]
  when "overdue"
    ["En retard", "bg-rose-50", "text-rose-700", "bg-rose-500"]
  else
    [(@invoice.status || "Brouillon").capitalize, "bg-slate-100", "text-slate-700", "bg-slate-400"]
  end %>

<% status_outline =
  case @invoice.status
  when "paid" then "border-emerald-200"
  when "pending" then "border-amber-200"
  when "overdue" then "border-rose-200"
  else "border-slate-200"
  end %>

<div class="mx-auto max-w-7xl space-y-6 pb-14">

  <!-- ================================================= -->
  <!-- HEADER / HERO -->
  <!-- ================================================= -->
  <section class="rounded-2xl border border-slate-200 bg-white shadow-[0_18px_70px_rgba(15,23,42,0.08)] overflow-hidden">
    <div class="h-1 w-full bg-gradient-to-r from-indigo-500 via-violet-600 to-fuchsia-500"></div>

    <div class="p-6 md:p-8">
      <!-- Row 1: breadcrumb + title + actions -->
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">

        <div class="min-w-0">
          <div class="flex flex-wrap items-center gap-2 text-[11px]">
            <%= link_to invoices_path,
                class: "inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 font-semibold text-slate-700 border border-slate-200 hover:bg-slate-50 transition" do %>
              ‚Üê Retour
            <% end %>

            <span class="text-slate-300">/</span>

            <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-3 py-1 font-semibold text-slate-700 border border-slate-200">
              üßæ Factures
            </span>

            <span class="text-slate-400">/</span>

            <span class="font-semibold text-slate-900">
              <%= @invoice.number.presence || "Facture ##{@invoice.id}" %>
            </span>

            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 font-semibold border <%= status_outline %> <%= status_bg %> <%= status_text %>">
              <span class="h-2 w-2 rounded-full <%= status_dot %>"></span>
              <%= status_label %>
            </span>
          </div>

          <h1 class="mt-3 text-2xl md:text-3xl font-semibold tracking-tight text-slate-900 truncate">
            <%= @invoice.number.presence || "Facture ##{@invoice.id}" %>
          </h1>

          <p class="mt-1 text-sm text-slate-500">
            üëá R√©cap clair + actions rapides pour g√©rer ta facture.
          </p>
        </div>

        <!-- Actions + micro help -->
        <div class="flex flex-col items-start gap-2 lg:items-end">
          <div class="flex flex-wrap items-center gap-2 lg:justify-end">
            <%= link_to invoice_path(@invoice, format: :pdf),
                        target: "_blank",
                        class: "inline-flex items-center gap-2 rounded-xl bg-violet-600 px-4 py-2.5 text-xs font-semibold text-white shadow-sm hover:bg-violet-700 transition" do %>
              üìÑ PDF
            <% end %>

            <%= link_to edit_invoice_path(@invoice),
                        class: "inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2.5 text-xs font-semibold text-white shadow-sm hover:bg-slate-800 transition" do %>
              ‚úèÔ∏è Modifier
            <% end %>

            <% if @invoice.status == "overdue" && @invoice.client&.email.present? %>
              <%= button_to send_reminder_invoice_path(@invoice),
                            method: :post,
                            data: { turbo: false },
                            form: { class: "inline-flex" },
                            class: "inline-flex items-center gap-2 rounded-xl bg-amber-500 px-4 py-2.5 text-xs font-semibold text-white shadow-sm hover:bg-amber-600 transition" do %>
                üîî Rappel
              <% end %>
            <% end %>

            <%= button_to invoice_path(@invoice),
                          method: :delete,
                          data: { turbo_confirm: "Tu es s√ªr de vouloir supprimer cette facture ?" },
                          form: { class: "inline-flex" },
                          class: "inline-flex items-center gap-2 rounded-xl bg-rose-600 px-4 py-2.5 text-xs font-semibold text-white shadow-sm hover:bg-rose-700 transition" do %>
              üóëÔ∏è Supprimer
            <% end %>
          </div>

          <p class="text-[11px] text-slate-500">
            Astuce : ouvre le PDF pour partager la facture avec le client.
          </p>
        </div>

      </div>

      <!-- Row 2: key dates -->
      <div class="mt-6 grid gap-3 sm:grid-cols-3">
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">üìÖ √âmise</p>
          <p class="mt-1 text-sm font-semibold text-slate-900">
            <%= @invoice.issue_date&.strftime("%d %b %Y") || "‚Äî" %>
          </p>
        </div>

        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">‚è≥ √âch√©ance</p>
          <p class="mt-1 text-sm font-semibold <%= @invoice.status == 'overdue' ? 'text-rose-700' : 'text-slate-900' %>">
            <%= @invoice.due_date&.strftime("%d %b %Y") || "‚Äî" %>
          </p>
        </div>

        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">üîî Dernier rappel</p>
          <p class="mt-1 text-sm font-semibold text-slate-900">
            <%= @invoice.last_reminder_sent_at.present? ? @invoice.last_reminder_sent_at.strftime("%d %b %Y %H:%M") : "‚Äî" %>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- ================================================= -->
  <!-- MAIN GRID -->
  <!-- ================================================= -->
  <section class="grid gap-6 lg:grid-cols-[1.65fr_1fr]">

    <!-- LEFT COLUMN -->
    <div class="space-y-6">

      <!-- CLIENT -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_8px_30px_rgba(15,23,42,0.06)]">
        <div class="p-6">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Client</p>
                  <p class="mt-1 text-lg font-semibold text-slate-900 truncate">üë§ <%= @client.name %></p>
                </div>

                <div class="hidden sm:block">
                  <span class="inline-flex items-center gap-2 rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-xs text-slate-700">
                    üÜî ID <span class="font-semibold text-slate-900"><%= @client.id %></span>
                  </span>
                </div>
              </div>

              <div class="mt-4 grid gap-3 sm:grid-cols-2">
                <% if @client.contact_name.present? %>
                  <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Contact</p>
                    <p class="mt-0.5 text-sm font-semibold text-slate-900"><%= @client.contact_name %></p>
                  </div>
                <% end %>

                <% if @client.email.present? %>
                  <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Email</p>
                    <p class="mt-0.5 text-sm font-semibold text-slate-900 break-all">‚úâÔ∏è <%= @client.email %></p>
                  </div>
                <% end %>

                <% if @client.respond_to?(:phone) && @client.phone.present? %>
                  <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 sm:col-span-2">
                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">T√©l√©phone</p>
                    <p class="mt-0.5 text-sm font-semibold text-slate-900">üìû <%= @client.phone %></p>
                  </div>
                <% end %>
              </div>

              <% if @client.respond_to?(:address) && (@client.address.present? || @client.city.present? || @client.zip_code.present?) %>
                <div class="mt-4 rounded-xl bg-white border border-slate-200 p-3 text-sm text-slate-700">
                  <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Adresse</p>
                  <p class="mt-1 text-[13px] text-slate-700 leading-snug">
                    üìç <%= @client.address %><br>
                    <%= [@client.zip_code, @client.city].compact.join(" ") %>
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <!-- COMPANY -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_8px_30px_rgba(15,23,42,0.06)]">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="mt-0.5">
              <%= render "shared/company_logo", company: @company %>
            </div>

            <div class="min-w-0 flex-1">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√âmis par</p>
              <p class="mt-1 text-lg font-semibold text-slate-900">üè¢ <%= @company.name %></p>

              <% if @company.legal_name.present? %>
                <p class="mt-1 text-[11px] text-slate-500"><%= @company.legal_name %></p>
              <% end %>

              <% if @company.address.present? || @company.city.present? || @company.zip_code.present? %>
                <div class="mt-4 rounded-xl bg-slate-50 border border-slate-200 p-3 text-sm text-slate-700">
                  <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Adresse</p>
                  <p class="mt-1 text-[13px] leading-snug">
                    üìç <%= @company.address %><br>
                    <%= [@company.zip_code, @company.city].compact.join(" ") %>
                    <% if @company.country.present? %><br><%= @company.country %><% end %>
                  </p>
                </div>
              <% end %>

              <div class="mt-4 grid gap-3 sm:grid-cols-2">
                <% if @company.siren.present? %>
                  <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">SIREN</p>
                    <p class="mt-0.5 text-sm font-semibold text-slate-900"><%= @company.siren %></p>
                  </div>
                <% end %>

                <% if @company.vat_number.present? %>
                  <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">TVA</p>
                    <p class="mt-0.5 text-sm font-semibold text-slate-900"><%= @company.vat_number %></p>
                  </div>
                <% end %>
              </div>

              <% if @company.email.present? || @company.phone.present? || @company.website.present? %>
                <div class="mt-4 flex flex-wrap gap-2 text-[11px] text-slate-600">
                  <% if @company.email.present? %>
                    <span class="inline-flex items-center gap-2 rounded-full bg-white border border-slate-200 px-3 py-1">üìß <%= @company.email %></span>
                  <% end %>
                  <% if @company.phone.present? %>
                    <span class="inline-flex items-center gap-2 rounded-full bg-white border border-slate-200 px-3 py-1">üìû <%= @company.phone %></span>
                  <% end %>
                  <% if @company.website.present? %>
                    <span class="inline-flex items-center gap-2 rounded-full bg-white border border-slate-200 px-3 py-1">üåê <%= @company.website %></span>
                  <% end %>
                </div>
              <% end %>

            </div>
          </div>
        </div>
      </section>

      <!-- NOTES -->
      <% if @invoice.notes.present? %>
        <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_8px_30px_rgba(15,23,42,0.06)]">
          <div class="p-6">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Conditions de paiement</p>
            <p class="mt-2 text-sm text-slate-700 whitespace-pre-line">üìù <%= @invoice.notes %></p>
          </div>
        </section>
      <% end %>

    </div>

    <!-- RIGHT COLUMN -->
    <aside class="space-y-6">

      <!-- SUMMARY -->
      <section class="lg:sticky lg:top-24 rounded-2xl bg-white border border-slate-200 shadow-[0_18px_70px_rgba(15,23,42,0.06)] overflow-hidden">
        <div class="h-1 w-full bg-gradient-to-r from-indigo-500 via-violet-600 to-fuchsia-500"></div>
        <div class="p-6">
          <div class="flex items-center justify-between">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">R√©capitulatif</p>
            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-semibold border <%= status_outline %> <%= status_bg %> <%= status_text %>">
              <span class="h-2 w-2 rounded-full <%= status_dot %>"></span>
              <%= status_label %>
            </span>
          </div>

          <dl class="mt-4 space-y-3 text-sm text-slate-700">
            <div class="flex justify-between">
              <dt class="text-slate-600">Sous-total HT</dt>
              <dd class="font-semibold text-slate-900"><%= number_to_currency(subtotal_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %></dd>
            </div>

            <div class="flex justify-between">
              <dt class="text-slate-600">TVA</dt>
              <dd class="font-semibold text-slate-900"><%= number_to_currency(vat_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %></dd>
            </div>

            <div class="h-px bg-slate-200"></div>

            <div class="flex items-end justify-between">
              <dt class="text-base font-semibold text-slate-900">Total TTC</dt>
              <dd class="text-2xl font-semibold tracking-tight text-violet-700">
                <%= number_to_currency(total_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %>
              </dd>
            </div>
          </dl>

          <div class="mt-4 rounded-xl bg-slate-50 border border-slate-200 p-3 text-[11px] text-slate-600">
            ‚úÖ Montants calcul√©s automatiquement √† partir des lignes.
          </div>
        </div>
      </section>

      <!-- PAYMENT INFOS -->
      <% if @company.payment_instructions.present? || @company.iban.present? || @company.bic.present? %>
        <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_8px_30px_rgba(15,23,42,0.06)]">
          <div class="p-6">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Informations de paiement</p>

            <% if @company.payment_instructions.present? %>
              <p class="mt-3 text-sm text-slate-700 whitespace-pre-line">üí≥ <%= @company.payment_instructions %></p>
            <% end %>

            <dl class="mt-4 space-y-3 text-xs text-slate-700">
              <% if @company.iban.present? %>
                <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">IBAN</dt>
                  <dd class="mt-1 font-semibold text-slate-900 break-all"><%= @company.iban %></dd>
                </div>
              <% end %>

              <% if @company.bic.present? %>
                <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">BIC</dt>
                  <dd class="mt-1 font-semibold text-slate-900"><%= @company.bic %></dd>
                </div>
              <% end %>
            </dl>
          </div>
        </section>
      <% end %>

      <!-- PAYMENT STATUS -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_8px_30px_rgba(15,23,42,0.06)]">
        <div class="p-6">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Paiement</p>

          <% if @invoice.status == "paid" %>
            <dl class="mt-4 space-y-3 text-xs text-slate-700">
              <div class="flex justify-between">
                <dt>Statut</dt>
                <dd class="font-semibold text-emerald-700">‚úÖ Pay√©e</dd>
              </div>

              <div class="flex justify-between">
                <dt>Date</dt>
                <dd class="font-semibold text-slate-900">
                  <%= @invoice.paid_at.present? ? @invoice.paid_at.strftime("%d %b %Y") : "Non renseign√©e" %>
                </dd>
              </div>

              <div class="flex justify-between">
                <dt>Moyen</dt>
                <dd class="font-semibold text-slate-900">
                  <% method_label =
                    case @invoice.payment_method
                    when "virement" then "Virement bancaire"
                    when "carte"    then "Carte bancaire"
                    when "paypal"   then "PayPal"
                    when "cheque"   then "Ch√®que"
                    when "especes"  then "Esp√®ces"
                    when "autre"    then "Autre"
                    else "Non renseign√©"
                    end %>
                  <%= method_label %>
                </dd>
              </div>

              <% if @invoice.payment_notes.present? %>
                <div class="mt-3 rounded-xl bg-slate-50 border border-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Note interne</dt>
                  <dd class="mt-1 text-[11px] text-slate-700 whitespace-pre-line"><%= @invoice.payment_notes %></dd>
                </div>
              <% end %>
            </dl>
          <% else %>
            <div class="mt-3 rounded-xl bg-slate-50 border border-slate-200 p-3 text-[11px] text-slate-600">
              ‚è∫Ô∏è Cette facture n‚Äôest pas encore marqu√©e comme pay√©e.
            </div>
          <% end %>
        </div>
      </section>

    </aside>
  </section>

  <!-- ================================================= -->
  <!-- LIGNES -->
  <!-- ================================================= -->
  <section class="rounded-2xl bg-white border border-slate-200 shadow-[0_18px_70px_rgba(15,23,42,0.06)] overflow-hidden">
    <div class="p-6 md:p-7">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">D√©tail</p>
          <h2 class="mt-1 text-lg font-semibold text-slate-900">üì¶ Lignes de facture</h2>
        </div>

        <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-[11px] font-semibold text-slate-700 border border-slate-200 shadow-sm">
          <span class="h-1.5 w-1.5 rounded-full bg-violet-600"></span>
          Calcul auto
        </span>
      </div>

      <div class="mt-5 overflow-x-auto rounded-xl border border-slate-200 bg-white">
        <table class="min-w-full text-left text-xs">
          <thead class="bg-slate-50 text-slate-500">
            <tr>
              <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[10px]">Description</th>
              <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[10px]">Qt√©</th>
              <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[10px]">PU</th>
              <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[10px]">TVA</th>
              <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[10px] text-right">Total</th>
            </tr>
          </thead>

          <tbody class="bg-white text-slate-800">
            <% @invoice.invoice_items.each do |item| %>
              <% unit_price = item.unit_price_cents.to_i / 100.0 %>
              <% line_total = item.line_total_cents.to_i / 100.0 %>

              <tr class="border-t border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3">
                  <div class="flex items-start gap-3">
                    <span class="mt-0.5 inline-flex h-7 w-7 items-center justify-center rounded-lg bg-slate-100 border border-slate-200 text-[12px]">üß©</span>
                    <div class="min-w-0">
                      <p class="text-[13px] font-semibold text-slate-900 truncate"><%= item.description.presence || "-" %></p>
                      <p class="mt-0.5 text-[11px] text-slate-500">Ligne de facturation</p>
                    </div>
                  </div>
                </td>

                <td class="px-4 py-3">
                  <span class="inline-flex rounded-lg bg-slate-50 border border-slate-200 px-2.5 py-1 text-[12px] text-slate-700">
                    <%= item.quantity.to_f %>
                  </span>
                </td>

                <td class="px-4 py-3">
                  <span class="text-[13px] text-slate-700">
                    <%= number_to_currency(unit_price, unit: "‚Ç¨", separator: ",", delimiter: " ") %>
                  </span>
                </td>

                <td class="px-4 py-3">
                  <span class="inline-flex rounded-lg bg-slate-50 border border-slate-200 px-2.5 py-1 text-[12px] text-slate-700">
                    <%= item.vat_rate.to_f %> %
                  </span>
                </td>

                <td class="px-4 py-3 text-right">
                  <span class="text-[13px] font-semibold text-slate-900">
                    <%= number_to_currency(line_total, unit: "‚Ç¨", separator: ",", delimiter: " ") %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-[11px] text-slate-500">
          üí° Conseil : ajoute des lignes claires (description + quantit√© + prix) pour √©viter les contestations.
        </p>

        <div class="inline-flex items-center gap-2 rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-xs text-slate-700">
          üî¢ <span class="text-slate-500">Lignes :</span>
          <span class="font-semibold text-slate-900"><%= @invoice.invoice_items.size %></span>
        </div>
      </div>

    </div>
  </section>

</div>
