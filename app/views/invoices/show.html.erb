<% @company ||= @invoice.company || current_user.company %>
<% @client  ||= @invoice.client %>

<% total_eur    = @invoice.total_cents.to_i / 100.0 %>
<% subtotal_eur = @invoice.subtotal_cents.to_i / 100.0 %>
<% vat_eur      = @invoice.vat_amount_cents.to_i / 100.0 %>

<% status_label, status_bg, status_text, status_dot =
  case @invoice.status
  when "paid"
    ["Pay√©e", "bg-emerald-50", "text-emerald-700", "bg-emerald-500"]
  when "pending"
    ["En attente", "bg-amber-50", "text-amber-700", "bg-amber-500"]
  when "overdue"
    ["En retard", "bg-rose-50", "text-rose-700", "bg-rose-500"]
  else
    [(@invoice.status || "Brouillon").capitalize, "bg-slate-100", "text-slate-700", "bg-slate-400"]
  end %>

<div class="mx-auto max-w-7xl space-y-6 pb-12">

  <!-- ================================================= -->
  <!-- TOP BAR -->
  <!-- ================================================= -->
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <%= link_to invoices_path,
                class: "inline-flex items-center gap-2 rounded-2xl bg-white px-3.5 py-2 text-xs font-semibold text-slate-800 ring-1 ring-slate-200 shadow-sm hover:bg-slate-50 transition" do %>
      <span class="inline-flex h-6 w-6 items-center justify-center rounded-xl bg-slate-100 ring-1 ring-slate-200">‚Üê</span>
      <span>Retour</span>
    <% end %>

    <div class="flex flex-wrap items-center gap-2 text-[11px]">
      <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-700 ring-1 ring-slate-200">
        <span class="h-1.5 w-1.5 rounded-full bg-violet-600"></span>
        Factures
      </span>
      <span class="text-slate-400">/</span>
      <span class="font-semibold text-slate-800">
        <%= @invoice.number.presence || "Facture ##{@invoice.id}" %>
      </span>
      <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 font-semibold ring-1 ring-slate-200 <%= status_bg %> <%= status_text %>">
        <span class="h-2 w-2 rounded-full <%= status_dot %>"></span>
        <%= status_label %>
      </span>
    </div>
  </div>

  <!-- ================================================= -->
  <!-- HEADER CARD -->
  <!-- ================================================= -->
  <section class="rounded-[32px] bg-white ring-1 ring-slate-200 shadow-[0_18px_70px_rgba(15,23,42,0.10)] overflow-hidden">
    <div class="h-1 w-full bg-gradient-to-r from-indigo-500 via-violet-600 to-fuchsia-500"></div>

    <div class="p-6 md:p-8">
      <div class="flex flex-col gap-5 lg:flex-row lg:items-start lg:justify-between">

        <!-- Title -->
        <div class="min-w-0">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Facture</p>

          <div class="mt-2 flex flex-wrap items-center gap-3">
            <h1 class="text-2xl font-semibold tracking-tight text-slate-900 truncate">
              <%= @invoice.number.presence || "Facture ##{@invoice.id}" %>
            </h1>

            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-semibold ring-1 ring-slate-200 <%= status_bg %> <%= status_text %>">
              <span class="h-2 w-2 rounded-full <%= status_dot %>"></span>
              <%= status_label %>
            </span>
          </div>

          <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-600">
            <span>√âmise : <span class="font-semibold text-slate-800"><%= @invoice.issue_date&.strftime("%d %b %Y") || "‚Äî" %></span></span>
            <span class="text-slate-300">‚Ä¢</span>
            <span>√âch√©ance : <span class="font-semibold <%= @invoice.status == 'overdue' ? 'text-rose-700' : 'text-slate-800' %>"><%= @invoice.due_date&.strftime("%d %b %Y") || "‚Äî" %></span></span>

            <% if @invoice.last_reminder_sent_at.present? %>
              <span class="text-slate-300">‚Ä¢</span>
              <span class="text-slate-500">
                Dernier rappel : <span class="font-semibold text-slate-700"><%= @invoice.last_reminder_sent_at.strftime("%d %b %Y √† %H:%M") %></span>
              </span>
            <% end %>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap items-center gap-2">
          <%= link_to invoice_path(@invoice, format: :pdf),
                      target: "_blank",
                      class: "inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-xs font-semibold text-white shadow-sm
                              bg-slate-900 hover:bg-slate-800 transition" do %>
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-white/10 ring-1 ring-white/10">‚¨áÔ∏è</span>
            PDF
          <% end %>

          <%= link_to edit_invoice_path(@invoice),
                      class: "inline-flex items-center gap-2 rounded-2xl bg-white px-4 py-2 text-xs font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 transition" do %>
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-slate-100 ring-1 ring-slate-200">‚úèÔ∏è</span>
            Modifier
          <% end %>

          <% if @invoice.status == "overdue" && @invoice.client&.email.present? %>
            <%= button_to send_reminder_invoice_path(@invoice),
                          method: :post,
                          data: { turbo: false },
                          class: "inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-xs font-semibold text-white shadow-sm
                                  bg-amber-500 hover:bg-amber-600 transition" do %>
              <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-white/15 ring-1 ring-white/15">üîî</span>
              Rappel
            <% end %>
          <% end %>

          <%= button_to duplicate_invoice_path(@invoice),
                        method: :post,
                        class: "inline-flex items-center gap-2 rounded-2xl bg-slate-100 px-4 py-2 text-xs font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-200/60 transition" do %>
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-white ring-1 ring-slate-200">‚éò</span>
            Dupliquer
          <% end %>

          <%= button_to invoice_path(@invoice),
                        method: :delete,
                        data: { turbo_confirm: "Tu es s√ªr de vouloir supprimer cette facture ?" },
                        class: "inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-xs font-semibold text-white shadow-sm
                                bg-rose-500 hover:bg-rose-600 transition" do %>
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-white/15 ring-1 ring-white/15">üóëÔ∏è</span>
            Supprimer
          <% end %>
        </div>
      </div>
    </div>
  </section>

  <!-- ================================================= -->
  <!-- MAIN GRID -->
  <!-- ================================================= -->
  <section class="grid gap-6 lg:grid-cols-[1.7fr_1.1fr]">

    <!-- LEFT -->
    <div class="space-y-6">

      <!-- Client -->
      <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
        <div class="p-6">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Client</p>
              <p class="mt-2 text-lg font-semibold text-slate-900 truncate"><%= @client.name %></p>

              <div class="mt-3 space-y-1 text-xs text-slate-700">
                <% if @client.contact_name.present? %>
                  <p><span class="font-semibold text-slate-600">Contact :</span> <%= @client.contact_name %></p>
                <% end %>
                <% if @client.email.present? %>
                  <p><span class="font-semibold text-slate-600">Email :</span> <%= @client.email %></p>
                <% end %>
                <% if @client.respond_to?(:phone) && @client.phone.present? %>
                  <p><span class="font-semibold text-slate-600">T√©l√©phone :</span> <%= @client.phone %></p>
                <% end %>
              </div>

              <% if @client.respond_to?(:address) && (@client.address.present? || @client.city.present? || @client.zip_code.present?) %>
                <div class="mt-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3 text-[11px] text-slate-600 leading-snug">
                  <%= @client.address %><br>
                  <%= [@client.zip_code, @client.city].compact.join(" ") %>
                </div>
              <% end %>
            </div>

            <div class="hidden sm:block text-right">
              <div class="rounded-2xl bg-slate-50 ring-1 ring-slate-200 px-3 py-2">
                <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">ID</p>
                <p class="mt-0.5 text-sm font-semibold text-slate-900"><%= @client.id %></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Entreprise -->
      <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="mt-0.5">
              <%= render "shared/company_logo", company: @company %>
            </div>

            <div class="min-w-0 flex-1">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√âmis par</p>
              <p class="mt-2 text-lg font-semibold text-slate-900"><%= @company.name %></p>

              <% if @company.legal_name.present? %>
                <p class="mt-1 text-[11px] text-slate-500"><%= @company.legal_name %></p>
              <% end %>

              <% if @company.address.present? || @company.city.present? || @company.zip_code.present? %>
                <div class="mt-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3 text-[11px] text-slate-600 leading-snug">
                  <%= @company.address %><br>
                  <%= [@company.zip_code, @company.city].compact.join(" ") %>
                  <% if @company.country.present? %><br><%= @company.country %><% end %>
                </div>
              <% end %>

              <div class="mt-3 grid gap-2 md:grid-cols-2 text-xs text-slate-700">
                <% if @company.siren.present? %>
                  <p><span class="font-semibold text-slate-600">SIREN :</span> <%= @company.siren %></p>
                <% end %>
                <% if @company.vat_number.present? %>
                  <p><span class="font-semibold text-slate-600">TVA :</span> <%= @company.vat_number %></p>
                <% end %>
              </div>

              <% if @company.email.present? || @company.phone.present? || @company.website.present? %>
                <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-[11px] text-slate-500">
                  <% if @company.email.present? %><span>üìß <%= @company.email %></span><% end %>
                  <% if @company.phone.present? %><span>üìû <%= @company.phone %></span><% end %>
                  <% if @company.website.present? %><span>üåê <%= @company.website %></span><% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <% if @invoice.notes.present? %>
        <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
          <div class="p-6">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Conditions de paiement</p>
            <p class="mt-2 text-sm text-slate-700 whitespace-pre-line"><%= @invoice.notes %></p>
          </div>
        </section>
      <% end %>

    </div>

    <!-- RIGHT -->
    <aside class="space-y-6">

      <!-- R√©cap -->
      <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
        <div class="h-1 w-full bg-gradient-to-r from-indigo-500 via-violet-600 to-fuchsia-500"></div>
        <div class="p-6">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">R√©capitulatif</p>

          <dl class="mt-4 space-y-2 text-sm text-slate-700">
            <div class="flex justify-between">
              <dt>Sous-total HT</dt>
              <dd class="font-semibold text-slate-900"><%= number_to_currency(subtotal_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %></dd>
            </div>

            <div class="flex justify-between">
              <dt>TVA</dt>
              <dd class="font-semibold text-slate-900"><%= number_to_currency(vat_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %></dd>
            </div>

            <div class="my-2 h-px bg-slate-200"></div>

            <div class="flex justify-between text-base font-semibold text-violet-700">
              <dt>Total TTC</dt>
              <dd><%= number_to_currency(total_eur, unit: "‚Ç¨", separator: ",", delimiter: " ") %></dd>
            </div>
          </dl>

          <div class="mt-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3 text-[11px] text-slate-600">
            Montants calcul√©s automatiquement √† partir des lignes.
          </div>
        </div>
      </section>

      <!-- Paiement instructions -->
      <% if @company.payment_instructions.present? || @company.iban.present? || @company.bic.present? %>
        <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
          <div class="p-6">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Informations de paiement</p>

            <% if @company.payment_instructions.present? %>
              <p class="mt-3 text-sm text-slate-700 whitespace-pre-line"><%= @company.payment_instructions %></p>
            <% end %>

            <dl class="mt-3 space-y-2 text-xs text-slate-700">
              <% if @company.iban.present? %>
                <div class="rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">IBAN</dt>
                  <dd class="mt-1 font-semibold text-slate-900 break-all"><%= @company.iban %></dd>
                </div>
              <% end %>

              <% if @company.bic.present? %>
                <div class="rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">BIC</dt>
                  <dd class="mt-1 font-semibold text-slate-900"><%= @company.bic %></dd>
                </div>
              <% end %>
            </dl>
          </div>
        </section>
      <% end %>

      <!-- Paiement status -->
      <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden">
        <div class="p-6">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Paiement</p>

          <% if @invoice.status == "paid" %>
            <dl class="mt-4 space-y-2 text-xs text-slate-700">
              <div class="flex justify-between">
                <dt>Statut</dt>
                <dd class="font-semibold text-emerald-700">Pay√©e</dd>
              </div>

              <div class="flex justify-between">
                <dt>Date</dt>
                <dd class="font-semibold text-slate-900">
                  <%= @invoice.paid_at.present? ? @invoice.paid_at.strftime("%d %b %Y") : "Non renseign√©e" %>
                </dd>
              </div>

              <div class="flex justify-between">
                <dt>Moyen</dt>
                <dd class="font-semibold text-slate-900">
                  <% method_label =
                    case @invoice.payment_method
                    when "virement" then "Virement bancaire"
                    when "carte"    then "Carte bancaire"
                    when "paypal"   then "PayPal"
                    when "cheque"   then "Ch√®que"
                    when "especes"  then "Esp√®ces"
                    when "autre"    then "Autre"
                    else "Non renseign√©"
                    end %>
                  <%= method_label %>
                </dd>
              </div>

              <% if @invoice.payment_notes.present? %>
                <div class="mt-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Note interne</dt>
                  <dd class="mt-1 text-[11px] text-slate-700 whitespace-pre-line"><%= @invoice.payment_notes %></dd>
                </div>
              <% end %>
            </dl>
          <% else %>
            <div class="mt-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-3 text-[11px] text-slate-600">
              Cette facture n‚Äôest pas encore marqu√©e comme pay√©e.
            </div>
          <% end %>
        </div>
      </section>

    </aside>
  </section>

  <!-- ================================================= -->
  <!-- LIGNES -->
  <!-- ================================================= -->
  <section class="rounded-3xl bg-white ring-1 ring-slate-200 shadow-[0_18px_70px_rgba(15,23,42,0.08)] overflow-hidden">
    <div class="p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">D√©tail</p>
          <h2 class="mt-1 text-lg font-semibold text-slate-900">Lignes de facture</h2>
        </div>
        <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-700 ring-1 ring-slate-200">
          <span class="h-1.5 w-1.5 rounded-full bg-violet-600"></span>
          Calcul auto
        </span>
      </div>

      <div class="mt-5 overflow-x-auto rounded-2xl border border-slate-200 bg-white">
        <table class="min-w-full text-left text-xs">
          <thead class="bg-slate-50 text-slate-500">
            <tr>
              <th class="px-3 py-3 font-semibold uppercase tracking-wide text-[10px]">Description</th>
              <th class="px-3 py-3 font-semibold uppercase tracking-wide text-[10px]">Qt√©</th>
              <th class="px-3 py-3 font-semibold uppercase tracking-wide text-[10px]">PU</th>
              <th class="px-3 py-3 font-semibold uppercase tracking-wide text-[10px]">TVA</th>
              <th class="px-3 py-3 font-semibold uppercase tracking-wide text-[10px] text-right">Total</th>
            </tr>
          </thead>
          <tbody class="bg-white text-slate-800">
            <% @invoice.invoice_items.each do |item| %>
              <% unit_price = item.unit_price_cents.to_i / 100.0 %>
              <% line_total = item.line_total_cents.to_i / 100.0 %>
              <tr class="border-t border-slate-100 hover:bg-slate-50">
                <td class="px-3 py-3">
                  <span class="text-[13px] font-semibold text-slate-900"><%= item.description.presence || "-" %></span>
                </td>
                <td class="px-3 py-3">
                  <span class="text-[13px] text-slate-700"><%= item.quantity.to_f %></span>
                </td>
                <td class="px-3 py-3">
                  <span class="text-[13px] text-slate-700">
                    <%= number_to_currency(unit_price, unit: "‚Ç¨", separator: ",", delimiter: " ") %>
                  </span>
                </td>
                <td class="px-3 py-3">
                  <span class="text-[13px] text-slate-700"><%= item.vat_rate.to_f %> %</span>
                </td>
                <td class="px-3 py-3 text-right">
                  <span class="text-[13px] font-semibold text-slate-900">
                    <%= number_to_currency(line_total, unit: "‚Ç¨", separator: ",", delimiter: " ") %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

    </div>
  </section>

</div>
